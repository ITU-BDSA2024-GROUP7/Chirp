@page "/{cheepId:int}/comments"
@using Chirp.Core
@using Chirp.Core.DTOs
@using Microsoft.AspNetCore.Mvc.TagHelpers
@model Chirp.Web.Pages.CheepCommentModel
@{
    ViewData["Title"] = "Chirp!";
    Layout = "Shared/_Layout";
    
    var CheepId = HttpContext.GetRouteValue("cheepId");
    int pageNumber = Model.PageNumber;
    int totalPages = Model.TotalPageNumber == 0 ? 1 : Model.TotalPageNumber;
    AuthorDTO userAuthor = Model.userAuthor;
}

<div>
    <div class="timeline-header">
        <a class="timeline-button" href="/">
            <button >Back</button>
        </a>
        <h2> Comment section </h2>
    </div>
       @if (Model.OriginalCheep != null)
{
    <div class="CommentForm">
        @if (User.Identity.IsAuthenticated)
        {
            <form method="post" style="display: flex; flex-direction: column; margin-bottom: 20px;">
                <input type="hidden" name="cheepId" value="@Model.OriginalCheep.CheepId" />
                <textarea name="Text" placeholder="Write a comment..." style="width: 100%; margin-bottom: 10px;" required></textarea>
                <button id="addCommentButton" type="submit" asp-page-handler="AddCommentToCheep">Add Comment</button>
            </form>
        }
    </div>
    
    <div class="Cheepforcomments">
        <strong>
            <a href="/@Model.OriginalCheep.Author.Name">@Model.OriginalCheep.Author.Name</a>
        </strong>
        
        @if (User.Identity.IsAuthenticated && Model.OriginalCheep.Author.Name != User.Identity.Name)
        {
            <form style="display: inline-block; margin-left: 2px;" method="post">
                @if (!Model.userAuthor.AuthorsFollowed.Contains(Model.OriginalCheep.Author.Name))
                {
                    <input type="hidden" name="followedAuthorName" value="@Model.OriginalCheep.Author.Name"/>
                    <input type="hidden" name="PageNumber" value="@ViewData["pageNumber"]" />
                    <button id="followButton" type="submit" asp-page-handler="FollowMethod">Follow</button>
                }
                else
                {
                    <input type="hidden" name="followedAuthor" value="@Model.OriginalCheep.Author.Name"/>
                    <input type="hidden" name="PageNumber" value="@ViewData["pageNumber"]" />
                    <button id="unfollowButton" type="submit" asp-page-handler="UnfollowMethod">Unfollow</button>
                }
            </form>
        }
        <br/>
        <small>@Model.OriginalCheep.FormattedTimeStamp</small>
        <p>@Model.OriginalCheep.Text</p>
    </div>
}

@if (Model.Comments != null && Model.Comments.Any())
{
    <ul id="messagelist" class="Comments">
        @foreach (var comment in Model.Comments)
        {
            <li>
                <div class="cheep-container">
                    <strong>
                        <a href="/@comment.Author.Name">@comment.Author.Name</a>
                    </strong>

                    @if (User.Identity.IsAuthenticated && comment.Author.Name != User.Identity.Name)
                    {
                        <form style="display: flex;" method="post">
                            @if (!Model.userAuthor.AuthorsFollowed.Contains(comment.Author.Name))
                            {
                                <input type="hidden" name="followedAuthorName" value="@comment.Author.Name"/>
                                <input type="hidden" name="PageNumber" value="@ViewData["pageNumber"]" />
                                <button id="followButton" type="submit" asp-page-handler="FollowMethod">Follow</button>
                            }
                            else
                            {
                                <input type="hidden" name="followedAuthor" value="@comment.Author.Name"/>
                                <input type="hidden" name="PageNumber" value="@ViewData["pageNumber"]" />
                                <button id="unfollowButton" type="submit" asp-page-handler="UnfollowMethod">Unfollow</button>
                            }
                        </form>
                    }
                </div>
                <small>@comment.FormattedTimeStamp</small>
                <p>@comment.Text</p>
            </li>
        }
    </ul>
}
else
{
    <em>There are no comments on this cheep so far.</em>
    <br/>
}
    <div style="text-align: center;">
        <div style="display: inline-block;">
            @if (@pageNumber != 1)
            {
                <a href="/@CheepId?page=1" style="text-decoration: none;">
                    <button style="display: inline; margin: 0;">&lt;&lt;</button>
                </a>
                <a href="/@CheepId?page=@(pageNumber - 1)" style="text-decoration: none; margin-right: 15px;">
                    <button style="display: inline; margin: 0;">&lt;</button>
                </a>
            }
            <p style="display: inline; margin: 0; margin-right: 15px;">Page @pageNumber / @totalPages</p>
            @if (@pageNumber != @totalPages)
            {
                <a href="/@CheepId?page=@(pageNumber + 1)" style="text-decoration: none;">
                    <button style="display: inline; margin: 0;">&gt;</button>
                </a>
                <a href="/@CheepId?page=@totalPages" style="text-decoration: none;">
                    <button style="display: inline; margin: 0;">&gt;&gt;</button>
                </a>
            }
            
        </div>
    </div>
</div>